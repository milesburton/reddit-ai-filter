name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  integration-test:
    name: Integration tests (model corpus)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Cache model files
        uses: actions/cache@v4
        with:
          path: .cache
          key: onnx-model-trentmkelly-slop-detector-mini-2

      - name: Run integration tests
        run: bun run test:integration

  release:
    name: Build, sign & release
    runs-on: ubuntu-latest
    needs: integration-test
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build & zip Firefox (MV2)
        run: bun run zip

      - name: Build & zip Chrome (MV3)
        # WXT zip for Chrome â€” produces a zip suitable for Chrome Web Store submission.
        # Note: Chrome MV3 uses a service worker background which is ephemeral.
        # The model reloads from cache (no re-download) after idle periods.
        run: bun wxt zip -b chrome

      - name: Install web-ext
        if: ${{ env.AMO_JWT_ISSUER != '' }}
        run: npm install -g web-ext
        env:
          AMO_JWT_ISSUER: ${{ secrets.AMO_JWT_ISSUER }}

      - name: Sign Firefox extension (unlisted)
        # Signs the built extension with Mozilla so Firefox will install it directly.
        # Skipped if AMO_JWT_ISSUER / AMO_JWT_SECRET secrets are not configured.
        # Generate credentials at: https://addons.mozilla.org/developers/addon/api/key/
        if: ${{ env.AMO_JWT_ISSUER != '' }}
        run: |
          web-ext sign \
            --channel=unlisted \
            --api-key="$AMO_JWT_ISSUER" \
            --api-secret="$AMO_JWT_SECRET" \
            --source-dir=.output/firefox-mv2 \
            --artifacts-dir=.output/signed
          # Rename to a predictable filename
          VERSION=$(node -p "require('./package.json').version")
          mv .output/signed/*.xpi ".output/signed/reddit-ai-filter-${VERSION}-firefox.xpi"
        env:
          AMO_JWT_ISSUER: ${{ secrets.AMO_JWT_ISSUER }}
          AMO_JWT_SECRET: ${{ secrets.AMO_JWT_SECRET }}

      - name: Publish to Chrome Web Store
        # Uploads and submits the Chrome zip for review.
        # Skipped if CHROME_EXTENSION_ID / CHROME_CLIENT_ID / CHROME_CLIENT_SECRET /
        # CHROME_REFRESH_TOKEN secrets are not configured.
        # Setup guide: https://github.com/fregante/chrome-webstore-upload-cli#setup
        if: ${{ env.CHROME_EXTENSION_ID != '' }}
        run: |
          npx chrome-webstore-upload-cli@latest upload --auto-publish \
            --source .output/reddit-ai-filter-*-chrome.zip \
            --extension-id "$CHROME_EXTENSION_ID" \
            --client-id "$CHROME_CLIENT_ID" \
            --client-secret "$CHROME_CLIENT_SECRET" \
            --refresh-token "$CHROME_REFRESH_TOKEN"
        env:
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # firefox zip + sources zip + chrome zip (+ signed xpi if AMO secrets configured)
          files: |
            .output/*.zip
            .output/signed/*.xpi
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
